<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æˆ‘å€‘çš„å›æ†¶åœ°åœ– â™¡ å®Œæ•´ç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --soft-pink: #ffdae0; --heart-red: #ff5e78; --bg-color: #fff9fa; --gold: #fffde7; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg-color); color: #444; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .header { text-align: center; margin-bottom: 15px; width: 100%; max-width: 1000px; }
        .nav-bar { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px; }
        .btn { background: white; border: 1.5px solid #ff9db2; padding: 8px 15px; border-radius: 50px; font-size: 13px; cursor: pointer; font-weight: bold; color: #7d8597; transition: 0.2s; }
        .btn:hover { background: #fff0f2; transform: translateY(-1px); }
        .btn-main { background: var(--heart-red) !important; color: white !important; border: none; }
        .merge-zone { background: white; padding: 5px 15px; border-radius: 50px; border: 1.5px solid var(--soft-pink); display: flex; align-items: center; gap: 5px; }
        .merge-zone input { border: none; outline: none; font-size: 12px; width: 100px; }
        .main-container { display: flex; flex-wrap: wrap; gap: 15px; width: 100%; max-width: 1000px; }
        .side-bar { flex: 1; min-width: 280px; display: flex; flex-direction: column; gap: 15px; }
        .content-area { flex: 2; min-width: 320px; }
        .card { background: white; padding: 15px; border-radius: 20px; border: 2px solid var(--soft-pink); box-shadow: 0 4px 10px rgba(255,192,203,0.2); position: relative; }
        .city-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .city-item { background: #fffcfd; border: 1px solid #ffeef0; padding: 8px 2px; border-radius: 10px; cursor: pointer; text-align: center; font-size: 12px; font-weight: bold; position: relative; }
        .city-item.active { background: var(--heart-red); color: white; }
        
        /* é€šç”¨çš„æ„›å¿ƒæ¨™è¨˜æ¨£å¼ï¼ˆç”¨æ–¼åŸå¸‚èˆ‡æœˆä»½ï¼‰ */
        .has-data::after { content: "â¤ï¸"; font-size: 9px; position: absolute; bottom: 2px; right: 2px; }
        .active.has-data::after { filter: brightness(2); }

        .lucky-box { background: var(--gold); border: 2px dashed #fdd835; }
        .lucky-content { background: rgba(255,255,255,0.7); padding: 10px; border-radius: 10px; margin-top: 8px; font-size: 13px; min-height: 45px; line-height: 1.5; }
        .diary-card { background: white; border-radius: 15px; overflow: hidden; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); position: relative; }
        .action-btns { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 5; }
        .icon-btn { background: white; border: 1px solid #ffdae0; color: #ff5e78; border-radius: 8px; padding: 3px 8px; font-size: 11px; cursor: pointer; }
        .stat-val { font-size: 18px; color: var(--heart-red); font-weight: bold; }
        textarea { width: 100%; border: 1px solid var(--soft-pink); border-radius: 10px; padding: 10px; box-sizing: border-box; resize: none; font-family: inherit; }
        .collage-title { font-family: 'Dancing Script', cursive; font-size: 32px; color: var(--heart-red); }
        .collage-footer { font-family: 'Dancing Script', cursive; font-size: 18px; color: #777; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

<div class="header">
    <h1 style="color:var(--heart-red); margin: 10px 0;">Our Story Map â™¡</h1>
    <div class="nav-bar">
        <button class="btn" onclick="exportJSON()">ğŸ’¾ å‚™ä»½</button>
        <button class="btn" onclick="document.getElementById('fIn').click()">ğŸ“¤ åŒ¯å…¥</button>
        <input type="file" id="fIn" hidden onchange="importJSON(this)">
        <button class="btn" onclick="copyCode()">ğŸ”— è¤‡è£½ä»£ç¢¼</button>
        <div class="merge-zone">
            <input type="text" id="mCode" placeholder="è²¼ä¸Šä»£ç¢¼...">
            <button class="btn" style="border:none; padding:2px 10px;" onclick="mergeCode()">åˆä½µ</button>
        </div>
        <button class="btn btn-main" onclick="showCollage()">âœ¨ å¹´åº¦æ‹¼è²¼</button>
    </div>
</div>

<div class="main-container">
    <div class="side-bar">
        <div class="card"><div class="city-grid" id="cityList"></div></div>
        
        <div class="card" style="background:#f0f7ff; border-color:#bcdbff;">
            <b>ğŸ“Š <span id="statYear">2026</span> æ—…éŠå›é¡§</b>
            <div style="display:flex; justify-content:space-around; margin-top:10px; text-align:center;">
                <div>åŸå¸‚<br><span id="statCity" class="stat-val">0</span></div>
                <div>å›æ†¶<br><span id="statCount" class="stat-val">0</span></div>
                <div>å¿ƒæƒ…<br><span id="statMood" class="stat-val">0</span></div>
            </div>
        </div>

        <div class="card lucky-box">
            <b>âœˆï¸ ä¸‹ä¸€ç«™å»å“ªè£¡ï¼Ÿ</b> <span style="float:right; cursor:pointer; color:var(--heart-red);" onclick="rndTravel()">æ›ä¸€å€‹</span>
            <div class="lucky-content" id="boxTravel">è¼‰å…¥ä¸­...</div>
        </div>
        <div class="card" style="background:#fff0f3;">
            <b>ğŸ’¬ çœŸå¿ƒè©±æŒ‘æˆ°</b> <span style="float:right; cursor:pointer; color:var(--heart-red);" onclick="rndTopic()">æ›ä¸€å€‹</span>
            <div class="lucky-content" id="boxTopic" style="color:#ff5e78;">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="card" style="text-align:center;">
            <div style="margin-bottom:10px;">
                <button class="btn" style="padding:2px 8px;" onclick="changeY(-1)">â€¹</button>
                <span id="yShow" style="font-weight:bold; margin:0 10px;">2026</span>
                <button class="btn" style="padding:2px 8px;" onclick="changeY(1)">â€º</button>
            </div>
            <div id="monGrid" style="display:grid; grid-template-columns:repeat(4,1fr); gap:5px;"></div>
        </div>
    </div>
    <div class="content-area" id="wall"></div>
</div>

<script>
    const S_KEY = 'love_map_vFinal';
    let db = JSON.parse(localStorage.getItem(S_KEY) || '{}');
    let currYear = 2026, currCity = "", currMon = "", tmpImg = "", selMood = "ğŸ˜Š", isCollage = false, editingId = null;

    const citiesData = { "å°åŒ—å¸‚":"å» 101 çœ‹å¤œæ™¯ã€é™½æ˜å±±æ¡æµ·èŠ‹", "æ–°åŒ—å¸‚":"å»æ·¡æ°´çœ‹å¤•é™½ã€ä¹ä»½è€è¡—å–èŒ¶", "åŸºéš†å¸‚":"å»æ­£æ¿±æ¼æ¸¯å½©è‰²å±‹æ‹ç¶²ç¾ç…§", "æ¡ƒåœ’å¸‚":"å» Xpark çœ‹æ°´æ¯ã€å¤§æºªè€è¡—èµ°èµ°", "æ–°ç«¹å¸‚":"å»å—å¯®æ¼æ¸¯é¨è…³è¸è»Šå¹é¢¨", "æ–°ç«¹ç¸£":"å»å¸é¦¬åº«æ–¯çœ‹ç¥æœ¨ã€å…§ç£é€›é€›", "è‹—æ —ç¸£":"å»å‹èˆˆè»Šç«™çœ‹èˆŠéµé“ã€æ¡è‰è“", "å°ä¸­å¸‚":"å»é«˜ç¾æ¿•åœ°çœ‹å¤•é™½ã€å¯©è¨ˆæ–°æ‘", "å½°åŒ–ç¸£":"å»é¹¿æ¸¯å¤©åå®®ã€åƒå¤§ä½›è‚‰åœ“", "å—æŠ•ç¸£":"å»æ—¥æœˆæ½­æ­èˆ¹ã€æ¸…å¢ƒè¾²å ´çœ‹ç¾Š", "é›²æ—ç¸£":"å»åŠæ¹–å±±ç©ã€è™å°¾éµæ©‹æ•£æ­¥", "å˜‰ç¾©å¸‚":"åƒæ–‡åŒ–è·¯æ—è°æ˜ã€æªœæ„æ£®æ´»æ‘", "å˜‰ç¾©ç¸£":"å»é˜¿é‡Œå±±çœ‹é›²æµ·ã€æ•…å®®å—é™¢", "å°å—å¸‚":"å»æ¼å…‰å³¶è¸æµªã€åƒéåœ‹è¯è¡—", "é«˜é›„å¸‚":"å»é§äºŒç‰¹å€ã€è¥¿å­ç£çœ‹å¤§èˆ¹", "å±æ±ç¸£":"å»å¢¾ä¸æ½›æ°´ã€å‹åˆ©æ˜Ÿæ‘å–å’–å•¡", "å®œè˜­ç¸£":"å»ç¤æºªæ³¡æº«æ³‰ã€æ¸…æ°´åœ°ç†±ç…®è›‹", "èŠ±è“®ç¸£":"å»å¤ªé­¯é–£çœ‹å±±æµ·ã€ä¸ƒæ˜Ÿæ½­ç–ŠçŸ³", "å°æ±ç¸£":"å»é¹¿é‡çœ‹ç†±æ°£çƒã€ä¸‰ä»™å°èµ°æ©‹", "æ¾æ¹–ç¸£":"å»èŠ±ç«ç¯€ã€ç©æ°´åƒä»™äººæŒå†°", "é‡‘é–€ç¸£":"å»çœ‹é¢¨ç…çˆºã€åƒå»£æ±ç²¥", "é¦¬ç¥–":"å»çœ‹è—çœ¼æ·šã€èŠ¹å£æ‘ç™¼å‘†" };
    const cityKeys = Object.keys(citiesData);
    const topics = ["æœ€è¿‘ä¸€æ¬¡å¿ƒå‹•æ˜¯ä»€éº¼æ™‚å€™ï¼Ÿ", "æœ€æƒ³è·Ÿæˆ‘å»å“ªå€‹åŸå¸‚ï¼Ÿ", "æˆ‘å“ªå¼µç…§ç‰‡ä½ æœ€å–œæ­¡ï¼Ÿ", "ç”¨ä¸‰å€‹è©å½¢å®¹æˆ‘", "æˆ‘å€‘ç¬¬ä¸€æ¬¡è¦‹é¢ä½ çš„æ„Ÿè¦ºï¼Ÿ"];

    function save() { try{ localStorage.setItem(S_KEY, JSON.stringify(db)); return true; }catch(e){ alert("ç©ºé–“æ»¿äº†ï¼"); return false; } }
    function exportJSON() { const blob = new Blob([JSON.stringify(db)], {type:"application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download="LoveMap.json"; a.click(); }
    function importJSON(input) { const reader = new FileReader(); reader.onload=(e)=>{ db=JSON.parse(e.target.result); save(); render(); alert("åŒ¯å…¥æˆåŠŸï¼"); }; reader.readAsText(input.files[0]); }
    function copyCode() { navigator.clipboard.writeText(JSON.stringify(db)).then(()=>alert("ä»£ç¢¼å·²è¤‡è£½")); }
    function mergeCode() { try { const inc = JSON.parse(document.getElementById('mCode').value); Object.keys(inc).forEach(c => { if(!db[c]) db[c]=inc[c]; else inc[c].forEach(ni=>{ if(!db[c].some(oi=>oi.id===ni.id)) db[c].push(ni); }); }); save(); render(); alert("åˆä½µå®Œæˆ"); } catch(e) { alert("ä»£ç¢¼éŒ¯èª¤"); } }

    function procImg(input, isEdit = false) {
        const r = new FileReader();
        r.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement('canvas'); const MAX = 800; let w = img.width, h = img.height;
                if(w > MAX) { h *= MAX/w; w = MAX; }
                cvs.width = w; cvs.height = h; cvs.getContext('2d').drawImage(img, 0, 0, w, h);
                const data = cvs.toDataURL('image/jpeg', 0.7);
                if(isEdit) { document.getElementById('editPrev').src = data; document.getElementById('editPrev').style.display='block'; }
                else { tmpImg = data; document.getElementById('preView').src = data; document.getElementById('preView').style.display = 'block'; }
            };
            img.src = e.target.result;
        };
        r.readAsDataURL(input.files[0]);
    }

    function add() {
        const note = document.getElementById('newNote').value;
        if(!note || !currCity) return alert("è«‹é¸æ“‡åŸå¸‚ä¸¦å¡«å¯«");
        if(!db[currCity]) db[currCity] = [];
        db[currCity].push({ id:Date.now(), date:document.getElementById('newDate').value, note, img:tmpImg, mood:selMood });
        if(save()){ tmpImg=""; render(); }
    }

    function edit(c, id) { editingId = id; render(); }
    function saveEdit(c, id) {
        const item = db[c].find(i => i.id === id);
        item.date = document.getElementById('editDate').value;
        item.note = document.getElementById('editNote').value;
        const newImg = document.getElementById('editPrev').src;
        if(newImg && newImg.startsWith('data:')) item.img = newImg;
        editingId = null; save(); render();
    }
    function del(c, id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")){ db[c]=db[c].filter(i=>i.id!==id); save(); render(); } }

    function updateStats() {
        let citySet = new Set(), count = 0, moodCount = 0;
        Object.entries(db).forEach(([c, arr]) => { arr.forEach(i => { if(i.date.startsWith(currYear)) { citySet.add(c); count++; moodCount++; } }); });
        document.getElementById('statYear').innerText = currYear;
        document.getElementById('statCity').innerText = citySet.size;
        document.getElementById('statCount').innerText = count;
        document.getElementById('statMood').innerText = moodCount;
    }

    function render() {
        if(isCollage) return;
        const wall = document.getElementById('wall');
        let list = [];
        if(currCity) list = db[currCity] || [];
        else if(currMon) Object.entries(db).forEach(([c, arr]) => { arr.forEach(i=>{ if(i.date.startsWith(currMon)) list.push({...i, cityName:c}); }); });
        else { wall.innerHTML = "<h2 style='text-align:center;color:#ccc;margin-top:50px;'>ğŸ’ é»æ“Šå·¦å´åŸå¸‚æˆ–æœˆä»½</h2>"; updateSidebar(); updateStats(); return; }

        let moods = ["ğŸ˜Š","ğŸ¥°","ğŸ¥³","ğŸ˜­","ğŸ˜¤"].map(m => `<span style="font-size:24px;cursor:pointer;opacity:${selMood===m?1:0.3}" onclick="selMood='${m}';render()">${m}</span>`).join(" ");
        let html = currCity ? `<div class="card" style="margin-bottom:15px;"><b>ğŸ“ ${currCity}</b><br><input type="date" id="newDate" value="${new Date().toISOString().split('T')[0]}" style="width:100%;margin:10px 0;padding:5px;"><div style="display:flex;justify-content:space-around;margin-bottom:10px;">${moods}</div><input type="file" accept="image/*" onchange="procImg(this)"><br><img id="preView" style="width:100%;display:none;border-radius:10px;margin:10px 0;"><textarea id="newNote" rows="3" placeholder="åœ¨é€™è£¡å¯«ä¸‹å›æ†¶..."></textarea><button class="btn btn-main" style="width:100%;margin-top:10px;" onclick="add()">å„²å­˜å›æ†¶</button></div>` : "";

        list.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(i => {
            const cName = currCity || i.cityName;
            if(editingId === i.id) {
                html += `<div class="diary-card" style="padding:15px; border:2px solid var(--heart-red);"><b>ç·¨è¼¯å›æ†¶ - ${cName}</b><input type="date" id="editDate" value="${i.date}" style="width:100%; margin:10px 0;"><input type="file" accept="image/*" onchange="procImg(this, true)"><img id="editPrev" src="${i.img || ''}" style="width:100%; margin:10px 0; border-radius:10px; ${i.img?'':'display:none'}"><textarea id="editNote" rows="4">${i.note}</textarea><div style="display:flex; gap:10px; margin-top:10px;"><button class="btn btn-main" style="flex:1" onclick="saveEdit('${cName}', ${i.id})">æ›´æ–°</button><button class="btn" style="flex:1" onclick="editingId=null;render()">å–æ¶ˆ</button></div></div>`;
            } else {
                html += `<div class="diary-card"><div class="action-btns"><button class="icon-btn" onclick="edit('${cName}', ${i.id})">âœï¸</button><button class="icon-btn" onclick="del('${cName}', ${i.id})">ğŸ—‘ï¸</button></div><div style="position:absolute;top:10px;left:10px;font-size:20px;">${i.mood}</div>${i.img ? `<img src="${i.img}" style="width:100%;">` : ""}<div style="padding:15px;"><b>${i.date} | ${cName}</b><p>${i.note}</p></div></div>`;
            }
        });
        wall.innerHTML = html;
        updateSidebar(); updateStats();
    }

    function updateSidebar() {
        // æ›´æ–°åŸå¸‚åˆ—è¡¨
        const cList = document.getElementById('cityList'); cList.innerHTML = "";
        cityKeys.forEach(c => {
            const hasData = db[c]?.length > 0;
            const d = document.createElement('div');
            d.className = `city-item ${currCity===c?'active':''} ${hasData?'has-data':''}`;
            d.innerText = c; d.onclick = ()=>{ currCity=c; currMon=""; isCollage=false; editingId=null; render(); };
            cList.appendChild(d);
        });

        // æ›´æ–°æœˆä»½åˆ—è¡¨ä¸¦æª¢æŸ¥è©²æœˆä»½æ˜¯å¦æœ‰æ•¸æ“š
        const mGrid = document.getElementById('monGrid'); mGrid.innerHTML = "";
        
        // å…ˆæ‰¾å‡ºç•¶å‰å¹´ä»½æ‰€æœ‰æœ‰æ•¸æ“šçš„æœˆä»½
        let monthsWithData = new Set();
        Object.values(db).flat().forEach(item => {
            if(item.date.startsWith(currYear)) {
                const month = item.date.split('-')[1]; // å–å¾— MM
                monthsWithData.add(parseInt(month));
            }
        });

        for(let i=1;i<=12;i++){
            const mStr = `${currYear}-${i<10?'0'+i:i}`;
            const hasData = monthsWithData.has(i);
            const d = document.createElement('div');
            d.className = `city-item ${currMon===mStr?'active':''} ${hasData?'has-data':''}`;
            d.innerText = i+"æœˆ"; 
            d.onclick = ()=>{ currMon=mStr; currCity=""; isCollage=false; editingId=null; render(); };
            mGrid.appendChild(d);
        }
        document.getElementById('yShow').innerText = currYear;
    }

    function rndTravel() { const c = cityKeys[Math.floor(Math.random()*cityKeys.length)]; document.getElementById('boxTravel').innerHTML = `ğŸ’¡ <b>${c}</b><br>${citiesData[c]}`; }
    function rndTopic() { document.getElementById('boxTopic').innerText = topics[Math.floor(Math.random()*topics.length)]; }
    function changeY(v) { currYear+=v; render(); }

    function showCollage() {
        isCollage = true; let pics = [];
        Object.values(db).flat().forEach(i=>{ if(i.date.startsWith(currYear) && i.img) pics.push(i.img); });
        document.getElementById('wall').innerHTML = `<div style="text-align:center;"><button class="btn btn-main" onclick="downC()" style="margin-bottom:15px;">ğŸ’¾ ä¸‹è¼‰æ‹¼è²¼ (Download)</button><div id="cArea" style="background:white; padding:30px 25px; border:1px solid #eee; width:400px; margin:auto; box-shadow:0 10px 30px rgba(0,0,0,0.1);"><div style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px;">${pics.map(p=>`<img src="${p}" style="width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:2px;">`).join("")}</div><div style="margin-top:25px;"><div class="collage-title" style="margin:0;">Sweet Memories ${currYear}</div><div class="collage-footer" style="margin-top:5px; opacity:0.7;">The Story of Us.</div></div></div><p style="margin-top:20px; color:#999; font-size:13px; cursor:pointer;" onclick="isCollage=false;render()">â† è¿”å›åœ°åœ–ä»‹é¢</p></div>`;
    }

    async function downC() { const c = await html2canvas(document.getElementById('cArea')); const a = document.createElement('a'); a.href=c.toDataURL(); a.download=`OurMemories_${currYear}.png`; a.click(); }

    rndTravel(); rndTopic(); render();
</script>
</body>
</html>